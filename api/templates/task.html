<html>
    <head>
        <title>Task</title>
        <script src="{{url_for('static', filename='lib/jquery.min.js')}}"></script>
        <script src="//cdn.rawgit.com/vkiryukhin/vkBeautify/master/vkbeautify.js"></script>
        <script src="{{url_for('static', filename='lib/verovio-toolkit.js')}}"></script>
        <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js"></script>
        <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
        <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}">
        <script>
        	function myFunction() {
        		var code = window.myCodeMirror.getValue();
        		var reviewer = document.getElementById("reviewer_name").value
        		console.log(code)
        		var url_args = ""
        		if(reviewer.length > 0){
        			url_args = "?u=" + reviewer
        		}
				alert("Thank you!");
				var settings = {
					"async": true,
					"crossDomain": true,
					"url": "../{{task._id}}"+url_args,
					"method": "POST",
					"headers": {
						"content-type": "application/xml"
					},
					"data": code
				}

				var thing = $.ajax(settings).done(function (response) {
					console.log(response);
				});
				
			}

			function render(){
				// console.log(vkbeautify.xmlmin(decode(window.myCodeMirror.getValue(), true)))
				// var options = {
				//     pageHeight: 600,
				//     pageWidth: 600
				// };
				pageHeight = ($(window).height() * 100) / 50 ;
			    pageWidth = ($(window).width() * 100) / 50 ;
			    options = {
			                pageHeight: pageHeight * 100,
			                pageWidth: (pageWidth * 100) / 50,
			                scale: (pageWidth / initial_width) * 50,
			                adjustPageHeight: true
			            };
				// var pre_xml = '<?xml version="1.0" encoding="UTF-8"?><?xml-model href="http://music-encoding.org/schema/3.0.0/mei-all.rng" type="application/xml" schematypens="http://relaxng.org/ns/structure/1.0"?><?xml-model href="http://music-encoding.org/schema/3.0.0/mei-all.rng" type="application/xml" schematypens="http://purl.oclc.org/dsdl/schematron"?><mei xmlns="http://www.music-encoding.org/ns/mei" meiversion="3.0.0"><meiHead></meiHead><music><body><mdiv xml:id="mdiv-0000002000259153"><score xml:id="score-0000001646574333"><scoreDef xml:id="scoredef-0000000917134699" key.sig="1f"><pgHead xml:id="pghead-0000002045266725"><rend xml:id="rend-0000000423485031" halign="left" valign="middle" fontsize="100.00%"><lb xml:id="lb-0000000931946803"/></rend><rend xml:id="rend-0000000423485032" halign="right" valign="middle" fontsize="100.00%"><abbr type="superscription"></abbr><lb xml:id="lb-0000000931946807"/></rend><rend xml:id="rend-0000000027109546" halign="center" valign="middle" fontweight="bold"><rend xml:id="rend-0000002081006402" fontsize="200.00%"></rend><rend xml:id="rend-0000001631646837" halign="center" valign="middle" fontsize="150.00%"><lb xml:id="lb-0000000495749948"/></rend><rend xml:id="rend-0000001631646838" halign="center" valign="middle" fontsize="150.00%"><lb xml:id="lb-0000000495749949"/></rend><rend xml:id="rend-0000001223265771" halign="center" valign="middle" fontsize="200.00%"><lb xml:id="lb-0000000931946442"/><rend fontsize="125%"></rend></rend><rend xml:id="rend-0000000481651677" halign="center" valign="middle" fontsize="100.00%"><lb xml:id="lb-0000000495749485"/></rend><rend xml:id="rend-0000001631646840" halign="center" valign="middle" fontsize="100.00%"> <lb xml:id="lb-0000000495749951"/></rend></rend></pgHead><pgFoot xml:id="pgfoot-0000000472217220"><fig xml:id="fig-0000001602740875" halign="center" valign="middle"><svg xmlns="http://www.w3.org/2000/svg" height="20" width="450"><g transform="scale(.45)"><path fill="black" d="M 17.11278,49.26451 V 10.367554 h 12.696511 c 3.288815,7.336676 6.71267,14.610456 10.127281,21.888976 3.419998,-7.484684 6.255515,-14.204887 9.58887,-21.909915 2.436207,0.103726 4.316952,0.08453 6.484294,-0.05808 V 49.264423 H 50.274275 C 50.145222,38.35639 50.016136,27.448368 49.887066,16.540329 45.003488,27.315459 39.967448,38.433564 35.083854,49.208695 34.678996,49.343717 34.426583,49.135619 34.021726,49.270644 29.46588,39.330716 24.910049,29.390805 20.354201,19.450876 20.224341,29.388756 20.09461,39.326619 19.964815,49.264497 H 17.11278 Z M 36.754144,39.324695 C 32.721221,30.512695 28.6883,21.700679 24.655394,12.888662 22.530527,12.750737 22.656775,12.71031 20.714356,12.813974 v 0.966497 c 4.612938,9.99784 9.609439,20.748709 13.87298,30.081745 0.722248,-1.512523 1.444528,-3.025014 2.166808,-4.537521 z m 25.738417,9.939815 c 0,-12.965651 0,-25.931305 0,-38.896956 10.084388,0 20.168791,0 30.253178,0 0,0.960416 0,1.920849 0,2.881265 -6.482825,0 -12.965652,0 -19.448478,0 0,4.802097 0,9.604178 0,14.406277 5.52241,0 11.044819,0 16.567229,0 0,0.960415 0,1.920832 0,2.881248 -5.52241,0 -11.044819,0 -16.567229,0 0,5.282306 0,10.564611 0,15.846917 6.963035,0 13.926068,0 20.889103,0 0,0.960416 0,1.920832 0,2.881249 -10.564597,0 -21.129207,0 -31.693803,0 z m 4.321874,-2.160937 c 0,-11.765131 0,-23.530263 0,-35.295394 -0.720312,0 -1.440625,0 -2.160937,0 0,11.765131 0,23.530263 0,35.295394 0.720312,0 1.440625,0 2.160937,0 z m 32.41413,2.160937 c 0,-12.965651 0,-25.931305 0,-38.896956 2.401045,0 4.802095,0 7.203135,0 0,12.965651 0,25.931305 0,38.896956 -2.40104,0 -4.80209,0 -7.203135,0 z m 2.881265,-2.160937 c 0,-11.765131 0,-23.530263 0,-35.295394 -0.72031,0 -1.44064,0 -2.160953,0 0,11.765131 0,23.530263 0,35.295394 0.720313,0 1.440643,0 2.160953,0 z"/><text y="48" x="555" fill="#00000" style="font-style:italic;font-weight:normal;font-size:45px;line-height:125%;text-anchor:middle" xml:space="preserve"></text><path fill="#00000" transform="translate(700,0)" d="m 346.3,6.7 c -3.1,0.5 -4.9,4.4 -2.7,6.8 1.2,1.4 2.7,2.4 4.1,3.5 -2.4,5.3 -7.7,8.3 -11.9,12.1 -3.7,2.8 -7,6.2 -9.7,9.9 -2.2,-0.8 -0.3,-6.8 -0.6,-9.5 0.1,-3.1 0.7,-6.4 2.9,-8.7 1.3,-1.9 3,-3.5 4.5,-5.2 1.2,-3.4 -3.2,-4.9 -5.8,-4.6 -7.3,-0.5 -14.6,2 -20,6.8 -5,4.6 -10,10.1 -11.5,17 -0.9,3.5 -0.2,7.5 2.8,9.9 2.5,2.8 7.4,2.9 9.8,-0.2 1.7,-2.3 3.2,-4.8 3.8,-7.6 -0.1,-2.6 -4.4,-2.3 -4.3,0.2 1.2,2.4 -0.9,4.7 -2.7,6.2 -1.7,0.9 -4.7,0.7 -4.8,-1.7 -1,-5.8 2.1,-11.3 5.2,-16.1 4,-5.8 9.8,-11.2 17.2,-11.8 1.6,0 8.1,-1.2 6.8,1.4 -2.8,2.8 -5.6,6.1 -6,10.3 -1.6,7.7 0.1,15.7 -2.3,23.2 -1.1,3.9 2,2.6 2.5,0.2 3.3,-7.4 8.9,-13.4 15.1,-18.5 4.2,-3.9 9.5,-7.1 11.9,-12.6 1.3,-3.6 1.2,-9 -2.7,-10.9 -0.6,-0.2 -1.2,-0.3 -1.8,-0.3 z m 66,14.5 c -2,0.8 -1.8,4.9 0.8,4.4 3.4,0.4 2.9,-6.2 -0.8,-4.4 z m 0.6,7.3 c -1.3,0.5 -7.6,0.5 -5.4,2.2 4,-0.3 0.7,4.5 0.6,6.7 -0.4,2.9 -2.4,5.9 -1.2,8.8 2.7,1.7 5.6,-0.8 6.8,-3.2 1.6,-1.4 -0.5,-3 -1.2,-0.9 -0.4,0.8 -2.4,3.5 -2.6,1.8 1.1,-5 2.7,-9.9 3.9,-14.9 l -0.1,-0.5 h -0.9 z m -65.1,0.2 c -6.5,1.6 -10.5,9.5 -8.2,15.7 2.1,3.4 7.4,2.9 10.1,0.4 2,-0.2 3.6,-5.3 1,-3.4 -1.4,2 -4,4.2 -6.5,2.8 -2.2,-1.9 -1.9,-5.7 1.7,-5.3 3.1,-0.9 6.9,-2.1 8.1,-5.5 0.9,-2.7 -1.6,-5.2 -4.3,-4.8 h -1.1 -0.7 z m 13.6,0 c -2.2,0 -8.5,1.8 -2.9,2.3 0.9,1.9 -1,4.9 -1.1,7.2 -0.5,2.9 -1.4,5.7 -1.7,8.7 3.7,0.7 3.8,-2.6 4.4,-5.3 0.9,-3.3 1.6,-7 4.1,-9.5 2.4,1.6 6.8,-0.7 3.7,-3.4 -2.9,-0.5 -4.8,2.4 -6.2,4.3 0,-1.2 2.4,-5 -0.2,-4.3 z m 15.8,0 c -6.4,1.3 -9.6,9.1 -7.7,14.9 1.9,4 7.7,3.9 11,1.7 4.1,-3 6,-8.9 4.4,-13.7 -1.3,-3 -4.8,-3.2 -7.6,-3 z m 17,0 c -2.3,0 -8.8,1.9 -3,2.4 0.4,2.5 -1,5.7 -1.4,8.4 -0.7,2.4 -1.8,7.5 2.1,7.2 3.8,-0.1 6.5,-3.5 8.5,-6.3 2,-3.2 4.5,-7 3.3,-10.9 -3.7,-3 -3.6,2.6 -3.1,5.1 -0.7,3.8 -2.7,7.9 -6.2,9.8 -3.6,0.6 -1,-4.3 -0.8,-6.1 0.6,-3.2 1.6,-6.3 1.9,-9.5 -0.4,0 -0.8,0 -1.1,0 z m 30.6,0 c -6.3,1.2 -9.5,8.9 -7.8,14.7 1.5,4 7.2,4.2 10.5,2.4 4.6,-2.8 6.6,-9.3 4.8,-14.3 -1.4,-2.8 -4.8,-3 -7.5,-2.8 z m -75.4,1.7 c 2.1,1.5 0.2,4.7 -1.6,5.7 -1.1,0.4 -5.5,3.4 -4.6,0.7 0.8,-2.7 2.2,-6.2 5.3,-6.6 l 0.9,0.1 z m 30.8,0 c 2.6,1.5 1.3,5.2 0.8,7.6 -0.8,2.7 -1.9,5.9 -4.7,7.1 -5.1,0.8 -4,-5.8 -2.8,-8.8 1,-2.8 3,-6.8 6.7,-5.8 z m 47.1,-0.1 c 2.9,0.7 2,4.7 1.5,6.8 -0.7,3 -1.8,6.7 -5,8 -4.7,0.8 -4,-5.1 -3,-7.9 0.9,-3 2.7,-7.3 6.5,-6.8 z m -88.1,5.9 c -0.3,1.3 0.9,-0.6 0,0 z m -1.1,2.4 c -0.2,0.5 0.5,-0.1 0,0 z m -1.3,4.5 c -0.3,1.3 0.8,-0.2 0,0 z" /></g></svg></fig></pgFoot><pgFoot2 xml:id="pgfoot2-0000001694763880"><rend xml:id="rend-0000001820920999" halign="center" valign="bottom"><rend xml:id="rend-0000000429776796" fontsize="xx-small"></rend></rend></pgFoot2><staffGrp xml:id="staffgrp-0000000868736446" bar.thru="true" symbol="brace"><staffDef xml:id="staffdef-0000000391696904" n="1" lines="5" ppq="480" clef.shape="G" clef.line="2" meter.count="2" meter.unit="4"><instrDef xml:id="instrdef-0000000112131969" midi.channel="0" midi.instrnum="0" midi.volume="78.00%"/></staffDef><staffDef xml:id="staffdef-0000002134705478" n="2" lines="5" ppq="480" clef.shape="F" clef.line="4" meter.count="2" meter.unit="4"><instrDef xml:id="instrdef-0000001950646165" midi.channel="1" midi.instrnum="0" midi.volume="78.00%"/></staffDef></staffGrp></scoreDef><section xml:id="section-0000001500539489"><section xml:id="Tema">'
				var pre_xml = '<?xml version="1.0" encoding="UTF-8"?><?xml-model href="https://music-encoding.org/schema/4.0.0/mei-all.rng" type="application/xml" schematypens="http://relaxng.org/ns/structure/1.0"?><?xml-model href="https://music-encoding.org/schema/4.0.0/mei-all.rng" type="application/xml" schematypens="http://purl.oclc.org/dsdl/schematron"?><mei xmlns="http://www.music-encoding.org/ns/mei" meiversion="4.0.0"><meiHead><fileDesc><titleStmt><title>32 VARIATIONEN</title><title type="subordinate" n="1">c-moll</title><title type="subordinate" n="2" label="Opus number">WoO 80</title><respStmt><persName role="composer">Ludwig van Beethoven</persName><persName role="encoder" enddate="2018-11-29T21:16:10">Werner Goebl</persName></respStmt></titleStmt><pubStmt/></fileDesc><encodingDesc xml:id="encodingdesc-0000001205577039"><appInfo xml:id="appinfo-0000001492290593"><application xml:id="application-0000001245369466" isodate="2018-11-23T11:17:35" version="2.0.0-dev-e42e3a6"><name xml:id="name-0000000401085565">Verovio</name><p xml:id="p-0000001059740050">Transcoded from MusicXML</p></application></appInfo></encodingDesc></meiHead><music><body><mdiv xml:id="mdiv-0000000720917863"><score xml:id="score-0000000926025859"><scoreDef xml:id="scoredef-0000000962089473" meter.count="3" meter.unit="4" key.mode="major" key.sig="3f"><staffGrp xml:id="staffgrp-0000001520233015" symbol="brace" label="." bar.thru="true"><staffDef xml:id="staffdef-0000000421725253" clef.shape="G" clef.line="2" n="1" lines="5"><instrDef xml:id="instrdef-0000000255494442" midi.channel="0" midi.instrnum="0" midi.volume="79.00%"/></staffDef><staffDef xml:id="staffdef-0000001701180460" clef.shape="F" clef.line="4" n="2" lines="5"><instrDef xml:id="instrdef-0000000070220525" midi.channel="1" midi.instrnum="0" midi.volume="74.00%"/></staffDef></staffGrp></scoreDef><section xml:id="section-WoO80"><section xml:id="section-Thema" n="0" label="Thema">'
			var post_xml = '</section></section></score></mdiv></body></music></mei>'

			// var post_xml = '</section></section></section></score></mdiv></body></music></mei>'
				vrvToolkit.loadData(pre_xml + decode(window.myCodeMirror.getValue()) + post_xml);
	        	// var svg = vrvToolkit.renderData(pre_xml + decode(window.myCodeMirror.getValue()) + post_xml, options);
	        	vrvToolkit.renderToSVG(1, options);
	        	$("#output").html(svg);

	        	resizeRender()
	        }
		</script>
		<script type="text/javascript" src="{{ url_for('static', filename='lib/codemirror.js') }}"></script>
		<link rel="stylesheet" href="{{ url_for('static', filename='lib/codemirror.css') }}">
		<script type="text/javascript" src="{{ url_for('static', filename='mode/javascript/javascript.js') }}"></script>
		<script type="text/javascript" src="{{ url_for('static', filename='mode/xml/xml.js') }}"></script>
		<style type="text/css">
		* {
		  box-sizing: border-box;
		}

		/* Create two equal columns that floats next to each other */
		.column {
		  float: left;
		  width: 50%;
		  padding: 10px;
		  /*height: 300px;  Should be removed. Only for demonstration */
		}

		/* Clear floats after the columns */
		.row:after {
		  content: "";
		  display: table;
		  clear: both;
		}

		/*img{ 
			width: 100%; 
			height: 100%; 
		}*/
		</style>
    </head>
    <body>
        <h1>Edit MEI Task</h1>
        <!-- <div><p>Task ID: {{ task._id }}</p>
        <p>Task Name: {{ task.name }}</p>
		<p>Task Description: {{ task.description }}</p></div> -->
        <div class="row">
	        <div class="column" ><b>Image</b></div>
	    	<div class="column" ><b>MEI Render</b></div>
        </div>
        <!-- show image -->
        <div class="row" style="border: thin solid black";>
	        <div class="column" style="border: thin solid black";><img src="{{url_for('static', filename=task.image_path)}}" alt="Music" id="slice_image" onclick="document.getElementById('id01').style.display='block'"></div>

	        <div id="id01" class="w3-modal">
		    <div class="w3-modal-content">
		      <div class="w3-container">
		        <span onclick="document.getElementById('id01').style.display='none'" class="w3-button w3-display-topright">&times;</span>
		        <img src="{{url_for('static', filename=task.image_path)}}">
		      </div>
		    </div>
		  </div>

	    	<div class="column" id="output" style="border: thin solid black";>
        </div>
		</div>
		<div><a href="/context/{{task._id}}" target="_blank">See the entire page</a></div>
        <!-- section with editable xml -->
        <div><p>Reviewer: </p>
        	<textarea id="reviewer_name" rows="1" cols="50"> 
        		
        	</textarea>
        </div>
        <div style="border: thin solid black";>
		    	<textarea id="editor">
				</textarea>
		</div>
		
        <!-- button and javascript for submitting post reqest with current xml -->
        <div>
        	 <button id="button" onClick="myFunction()" type="button">Submit</button>
        	 <button id="render_button" onClick="render()" type="button">Render</button> 
        </div>
        
    </body>

    <script type="text/javascript">
			function decode(text) {
			    return text.replace(/&apos;/g, "'")
			               .replace(/&#34;/g, '"')
			               .replace(/&gt;/g, '>')
			               .replace(/&lt;/g, '<')
			               .replace(/&amp;/g, '&');
			  };

			try {
				var xml_text = '{{xml}}'
				xml_text = decode(xml_text)
				var myCodeMirror = CodeMirror(function(elt) {
					editor.parentNode.replaceChild(elt, editor);
				}, {
					// value: xml_text,
					value: vkbeautify.xml(xml_text),
					lineNumbers: true
				});
			}
			catch(err) {
  				console.log(err.message)
			}

			document.getElementById("reviewer_name").value = ""

			var vrvToolkit = new verovio.toolkit();
		    var xml_text = '{{xml}}'
			xml_text = decode(xml_text)
		    /* Load the file using HTTP GET */
		    var options = {
			    pageHeight: 600,
			    pageWidth: 600,
			    ignoreLayout: 1,
			    border: 50,
			    scale: 75
			};
			var pre_xml = '<?xml version="1.0" encoding="UTF-8"?><?xml-model href="https://music-encoding.org/schema/4.0.0/mei-all.rng" type="application/xml" schematypens="http://relaxng.org/ns/structure/1.0"?><?xml-model href="https://music-encoding.org/schema/4.0.0/mei-all.rng" type="application/xml" schematypens="http://purl.oclc.org/dsdl/schematron"?><mei xmlns="http://www.music-encoding.org/ns/mei" meiversion="4.0.0"><meiHead><fileDesc><titleStmt><title>32 VARIATIONEN</title><title type="subordinate" n="1">c-moll</title><title type="subordinate" n="2" label="Opus number">WoO 80</title><respStmt><persName role="composer">Ludwig van Beethoven</persName><persName role="encoder" enddate="2018-11-29T21:16:10">Werner Goebl</persName></respStmt></titleStmt><pubStmt/></fileDesc><encodingDesc xml:id="encodingdesc-0000001205577039"><appInfo xml:id="appinfo-0000001492290593"><application xml:id="application-0000001245369466" isodate="2018-11-23T11:17:35" version="2.0.0-dev-e42e3a6"><name xml:id="name-0000000401085565">Verovio</name><p xml:id="p-0000001059740050">Transcoded from MusicXML</p></application></appInfo></encodingDesc></meiHead><music><body><mdiv xml:id="mdiv-0000000720917863"><score xml:id="score-0000000926025859"><scoreDef xml:id="scoredef-0000000962089473" meter.count="3" meter.unit="4" key.mode="major" key.sig="3f"><staffGrp xml:id="staffgrp-0000001520233015" symbol="brace" label="." bar.thru="true"><staffDef xml:id="staffdef-0000000421725253" clef.shape="G" clef.line="2" n="1" lines="5"><instrDef xml:id="instrdef-0000000255494442" midi.channel="0" midi.instrnum="0" midi.volume="79.00%"/></staffDef><staffDef xml:id="staffdef-0000001701180460" clef.shape="F" clef.line="4" n="2" lines="5"><instrDef xml:id="instrdef-0000000070220525" midi.channel="1" midi.instrnum="0" midi.volume="74.00%"/></staffDef></staffGrp></scoreDef><section xml:id="section-WoO80"><section xml:id="section-Thema" n="0" label="Thema">'
			var post_xml = '</section></section></score></mdiv></body></music></mei>'
	        var svg = vrvToolkit.renderData(pre_xml + xml_text + post_xml, options);
	        $("#output").html(svg);
		</script>
		<script type="text/javascript">

			var initial_width = $(window).width();

			function resize(){
				var height = document.getElementById("slice_image").height; 
				var width =document.getElementById("slice_image").width; 

				w_height = $(window).height();
				w_width = $(window).width();

				var ratio = (w_width / 2 - 50) / width
				var new_width = (w_width / 2 - 50)
				var new_height = ratio * height
				
				if(new_height > (0.4 * w_height)){
					ratio = (w_height / 2 - 50) / new_height
					new_height = (w_height / 2 - 50)
					new_width = ratio * new_width
				}

				document.getElementById("slice_image").width = new_width
				document.getElementById("slice_image").height = new_height

				resizeRender()


				// console.log("window: " + w_height + " x " + w_width)
				// console.log("image: " + document.getElementById("slice_image").width + " x " + document.getElementById("slice_image").height)
				// console.log("new_image: " + new_width + " x " + new_height)
				// console.log("ratio: " + ratio)
			}
			resize()
			function resizeRender(){
				    //////////////////////////////////////////////////////////////
				    /* Adjust the height and width according to the window size */
				    //////////////////////////////////////////////////////////////
				    pageHeight = ($(window).height() * 100) / 50 ;
				    pageWidth = ($(window).width() * 100) / 50 ;
				    options = {
				                pageHeight: pageHeight * 100,
				                pageWidth: (pageWidth * 100) / 50,
				                scale: (pageWidth / initial_width) * 50,
				                adjustPageHeight: true
				            };
		            vrvToolkit.redoLayout()
				    vrvToolkit.setOptions(options);
				    var svg = vrvToolkit.renderToSVG(1,options);
        			$("#output").html(svg);
			        
        			// vrvToolkit.redoLayout()
        			// svg = vrvToolkit.renderToSVG(1, {});
        			// $("#output").html(svg);

        			// adjust_page_height();
			}
			$(window).on('resize', resize);

		</script>
</html>